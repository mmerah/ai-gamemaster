## PROMPT 1

I am working on a concept for an open-source project. It would launch a web UI to play dungeon&dragons (5e) with an AI being the Game Master. Here are my ideas:
- The 'game' window would contain a party on the left. Each character of the party would be represented by an icon, with its name, race, class, level. Clicking on the card would show the details of the character (all information, stats, proficiencies, languages, class features, feats, equipment, personality traits, ideal, bond, flaw, roleplaying notes, verbal style, appearance, ...). On the middle of the window, there would be the chat window with the game master messages giving options for roleplay and a 'free choice' where you can just using a text prompt to say what you do. On the left, there would be the map of the current location, generated by an AI (for the moment, I just want a placeholder because I haven't found an AI that can do those maps correctly).
- Before going into a 'game', there would be a launch screen. At the moment I am imagining 3 options:
  1. 'Campaign': Goes to a screen where the user can configure a campaign. The user can either upload a campaign that he has, select an existing campaign or describe a campaign as a prompt. The user can select one of the existing/created campaign, then select a party from the existing characters, then select characters to be controlled by the Game Master and the character that the user want to play. A campaign also has a ruleset associated. Finally this launches a game.
  2. 'Character': Goes to a screen with a list of characters that were created. The user can see the details of each (similar to the 'game' window). The user can also create a new one.
  3. 'Rules': Goes to a screen where you can see/add rulesets.

## Example of System Prompt for a dungeon master

I used this system prompt successfully to have engaging DnD campaigns with an AI. Obviously it would need to be changed in some ways in order for it to be compatible with our system.
Also it would be cool if the style guide could be customized when configuring a campaign.

### Prompt
Name: "Dungeon Master" description: "A helpful and engaging Dungeon Master for D&D 5th Edition." instruction: | Purpose: To guide players through a D&D 5e adventure, providing immersive descriptions, managing combat encounters, roleplaying NPCs, and facilitating engaging gameplay.

Style Guide:
- Speak using conversational language free of jargon, using contemporary idioms, colloquialisms, discourse markers, and contractions to create a naturally engaging tone

Describing Locations:
- Sensory Details: Engage multiple senses with descriptive adjectives and adverbs.
- Environmental Details: Include terrain, architecture, and atmosphere, hinting at hazards and clues.
- Mood and Atmosphere: Use language that sets the tone and evokes emotions.
- Clarity and Conciseness: Focus on important details and convey them effectively.
- Player Focus: Direct descriptions to relate to player characters' experiences.
- Implementation Guidance: Use varied sentence structure and figurative language. Tailor descriptions to the location and its significance.

Combat Encounters:
- Initiative Tracking: Roll initiative, communicate turn order, and maintain it throughout combat.
- Combat Calculations: Show all calculations for every action, including attack rolls, damage rolls, and saving throws, within a single code block.
- Spatial Awareness (Theater of the Mind): Describe relative positions and movement for visualization.
- Clear Communication: State enemy actions, hit points, status effects, and other relevant details.
- Dynamic Descriptions: Use vivid and detailed language to describe the battlefield and combat maneuvers.
- Concise Information: Avoid lengthy descriptions that slow down combat.
- Tactical Awareness: Provide information about environmental effects on combat.
- Player Focus: Clearly state the effects of player actions and enemy actions on characters.
- Implementation Guidance: Use dynamic rhythm, sensory details, and maintain pace. Use enemy history/culture when appropriate. Clearly communicate dice rolls and effects.
- Combat Encounters (General): Do not reveal NPC stats (AC, HP, etc.) to the players unless a specific ability or spell would reveal that information.

NPC/Social Encounters:
- NPC Personality: Emulate personality, voice, and mannerisms.
- Information Delivery: Provide relevant information based on player questions and actions.
- Roleplaying Facilitation: Encourage interaction and respond to player actions to advance the story.
- Clarity and Engagement: Maintain clear dialogue and use descriptive language.
- Contextual Awareness: Use NPC history/culture, and show how social standing affects interactions.
- Implementation Guidance: Use dialogue, description, and action. Incorporate nonverbal cues. Adapt to player actions and campaign tone.

Using Skill Checks and Saving Throws:
- Situation Awareness: Identify situations for checks and throws, and prompt players proactively.
- Clear Explanations: Explain the skill or throw and potential consequences.
- Consistent Presentation: Display dice rolls in the boxed format.
- Fairness and Consistency: Apply rules fairly and consistently.
- Implementation Guidance: Use checks and throws to enhance narrative and create choices. Tailor difficulty to characters and situation.

Meta Conversation with Players:
- Clear and Concise Explanations: Provide simple explanations of rules and mechanics.
- Friendly and Supportive Tone: Maintain a welcoming atmosphere.
- Separation of Knowledge: Distinguish between player and character knowledge.
- Facilitating Planning: Allow planning and provide relevant information.
- Smooth Transitions: Use cues and prompts to return to roleplaying.
- Implementation Guidance: Use simple language, be patient, encourage questions, and provide helpful reminders.

Implementation Guidance (General):
- Any time a dice roll is shown to the players, display it within a code block, using the following format: 
```
(Dice roll + modifiers = result)
```

## Example of a character sheet
Format is a bit inconsistent but here are some character example that I used before. Obviously, we would need to set them correctly in a file, with a definite format for correct treatment
### Character sheet 1
**Sam**
*Class:* Bard 1
*Alignment:* Neutral Good
*Race:* Variant Human
*Gender:* Male
*Age:* Young Adult
*Background:* Urchin
*Level:* 1
*Player Name:* User

**Stats**
| Stat | Score | Modifier | Saving Throw |
|---|---|---|---|
| STR | 8 | -1 | -1 |
| DEX | 14 | +2 | **+4** |
| CON | 14 | +2 | +2 |
| INT | 10 | +0 | +0 |
| WIS | 12 | +1 | +1 |
| CHA | 17 | +3 | **+5** |
| **(Bold indicates proficiency)** | | | |

**Proficiencies & Languages**
*   **Armor:** Light armor
*   **Weapons:** Simple weapons, hand crossbows, longswords, rapiers, shortswords
*   **Tools:** Disguise Kit, Thieves' Tools, Lute, Drum, Bagpipes
*   **Languages:** Common, Goblin

**Racial Traits (Variant Human)**
*   **Ability Score Increase:** +1 DEX, +1 CON (Included in scores)
*   **Skill:** Perception proficiency
*   **Feat:** Actor
*   **Extra Language:** Goblin

**Key Stats**
| Stat | Value | Details |
|---|---|---|
| HP | 10 / 10 | (8 + CON mod 2) |
| AC | 13 | (Leather Armor 11 + DEX mod 2) |
| Initiative | +2 | (DEX mod) |
| Speed | 30 ft | |
| Hit Dice | 1d8 | |
| Proficiency Bonus | +2 | |
| Passive Perception | 13 | (10 + Perception bonus 3) |

**Class Features (Bard)**
*   **Spellcasting:** You can cast Bard spells using Charisma. See Spellcasting section below.
*   **Bardic Inspiration:** As a bonus action, you can inspire one creature within 60 feet who can hear you. For 10 minutes, the creature can add one Bardic Inspiration die (a d6) to one ability check, attack roll, or saving throw it makes. They can wait until after rolling the d20 before deciding to use the die, but must decide before the DM says whether the roll succeeds or fails. Once the die is rolled, it is lost. You can use this feature 3 times (equal to your CHA modifier) and regain all expended uses when you finish a long rest.

**Background Feature (Urchin)**
*   **City Secrets:** You know the secret patterns and flow to cities and can find passages through the urban sprawl that others would miss. When you are not in combat, you (and companions you lead) can travel between any two locations in the city twice as fast as your speed would normally allow.

**Feat (Actor)**
*   Increase your Charisma score by 1, to a maximum of 20. (Included in score)
*   You have advantage on Charisma (Deception) and Charisma (Performance) checks when trying to pass yourself off as a different person.
*   You can mimic the speech of another person or the sounds made by other creatures. You must have heard the person speaking, or heard the creature make the sound, for at least 1 minute. A successful Wisdom (Insight) check contested by your Charisma (Deception) check allows a listener to determine that the effect is faked.

**Spellcasting**
*   **Spellcasting Ability:** Charisma
*   **Spell Save DC:** 13 (8 + 2 Prof + 3 CHA)
*   **Spell Attack Bonus:** +5 (2 Prof + 3 CHA)
*   **Cantrips Known (At Will):** Vicious Mockery, Minor Illusion
*   **1st-Level Spells Known (4):** Charm Person, Faerie Fire, Healing Word, Sleep
*   **Spell Slots:** 2 x 1st-level slots per long rest

**Weapon Table**
| Weapon | Atk Bonus | Damage/Type | Properties |
|---|---|---|---|
| Rapier | +4 | 1d8+2 Piercing | Finesse |
| Dagger | +4 | 1d4+2 Piercing | Finesse, Light, Thrown (range 20/60) |

**Equipment**
*   Rapier
*   Dagger (x2)
*   Lute
*   Leather Armor
*   Entertainer's Pack (backpack, bedroll, 2 costumes, 5 candles, 5 days rations, waterskin, disguise kit)
*   Map of home city
*   Pet mouse (Ratatouille)
*   Token to remember parents
*   Common clothes
*   Belt pouch with 10 gp

**Skills Table**
| Skill | Mod | Bonus | Proficient |
|---|---|---|---|
| Acrobatics | DEX | +2 | --- |
| Animal Handling | WIS | +1 | --- |
| Arcana | INT | +0 | --- |
| Athletics | STR | -1 | --- |
| Deception | CHA | +3 | --- |
| History | INT | +0 | --- |
| Insight | WIS | +3 | **Yes** |
| Intimidation | CHA | +3 | --- |
| Investigation | INT | +0 | --- |
| Medicine | WIS | +1 | --- |
| Nature | INT | +0 | --- |
| Perception | WIS | +3 | **Yes** |
| Performance | CHA | +5 | **Yes** |
| Persuasion | CHA | +5 | **Yes** |
| Religion | INT | +0 | --- |
| Sleight of Hand | DEX | +4 | **Yes** |
| Stealth | DEX | +4 | **Yes** |
| Survival | WIS | +1 | --- |

**Personality**
*   **Trait 1:** I ask a lot of questions.
*   **Trait 2:** I bluntly say what other people are hinting at or hiding.
*   **Ideal:** Community. We have to take care of each other, because no one else is going to do it. (Neutral Good)
*   **Bond:** I owe my survival to another urchin who taught me to live on the streets.
*   **Flaw:** I will never fully trust anyone other than myself.

---

**Roleplaying Notes for Sam:**

*   **Core Concept:** Sam is a street-smart performer whose Bardic talents are layered over a tough Urchin upbringing. Their high Charisma fuels their magic, persuasive abilities, and performances (enhanced further by the Actor feat for mimicry and impersonation), while their background grants them practical skills like Stealth, Sleight of Hand, and Thieves' Tools proficiency. Driven by a desire for community and mutual support (Ideal), Sam is nonetheless hampered by deep-seated trust issues (Flaw) and a tendency towards bluntness (Trait 2). This creates a character who can charm and inspire, but also observes keenly (Perception/Insight) and keeps an emotional distance. Their Neutral Good alignment suggests a focus on helping others, especially the downtrodden, but likely through practical, sometimes unconventional means rather than strict adherence to law. The low Strength contrasts with their agility (good Dexterity) and force of personality.

*   **Verbal Style:**
    *   *Vocabulary:* Likely shifts between the direct, possibly slang-filled language of the streets (Urchin background, Goblin language) and the more articulate or evocative language used in performance (Bard). Prone to frequent, direct questioning ("I ask a lot of questions"). The Actor feat allows for impressive vocal mimicry.
    *   *Tone:* Can switch rapidly. Capable of being genuinely charming, persuasive, and inspiring (high CHA, Persuasion/Performance +5). However, this can give way to blunt, unfiltered observations ("I bluntly say what other people are hinting at...") or a guarded, perhaps slightly cynical tone stemming from distrust (Flaw). Curious when asking questions.
    *   *Focus:* Conversations likely center on immediate needs, understanding situations ("ask a lot of questions"), rallying support for the group or community (Ideal), navigating social situations (Bard), and perhaps reminiscing or seeking connection related to their past (Bond). Will likely call out perceived dishonesty or hidden motives (Trait 2, Insight proficiency).
    *   *Sentence Structure:* Probably defaults to concise, direct sentences reflecting their bluntness and Urchin background. Can likely adopt more flowing, complex structures when performing, persuading, or consciously using their Bardic charm.

*   **Mannerisms (Guidance):**
    *   Physically, Sam is likely agile and light-footed (DEX 14, Stealth +4) rather than imposing (STR 8). May have habits from the street, like sleeping defensively or keeping belongings close (Trait 4 suggestion, Flaw).
    *   Likely very expressive during performances (Performance +5, Actor feat) but potentially more reserved or watchful in casual interaction (Flaw, Insight +3, Perception +3). Eyes might dart around, taking in details.
    *   May use Sleight of Hand (+4) for minor tricks or distractions, possibly unconsciously. Likely skilled with disguise (Disguise Kit proficiency, Actor Feat).
    *   Interaction with Ratatouille, the pet mouse, could reveal a softer, more trusting side.
    *   Their bluntness combined with high Charisma might lead to accidentally charming insults or awkward truths delivered with a smile. They might struggle genuinely accepting help or relying on others due to their distrust (Flaw), despite valuing community (Ideal).

### Character sheet 2
**Character Name:** Amona
**Class:** Sorcerer (Wild Magic)
**Alignment:** Chaotic Good
**Race:** Tiefling
**Gender:** Female
**Age:** 20
**Background:** Acolyte
**Level:** 1
**Player Name:** User

| Stat | Score | Modifier | Saving Throw |
|---|---|---|---|
| STR | 8 | -1 | -1 |
| DEX | 13 | +1 | +1 |
| CON | 14 | +2 | **+4** |
| INT | 11 | +0 | +0 |
| WIS | 12 | +1 | +1 |
| CHA | 17 | +3 | **+5** |
| **(Bold indicates proficiency)** | | | |

**Proficiencies & Languages:**
*   **Armor:** None
*   **Weapons:** Daggers, darts, slings, quarterstaffs, light crossbows
*   **Tools:** None
*   **Languages:** Common, Infernal, Celestial, Draconic

**Racial Traits:**
*   **Darkvision:** You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if it were dim light.
*   **Hellish Resistance:** You have resistance to fire damage.
*   **Infernal Legacy:** You know the *Thaumaturgy* cantrip.

| Stat               | Value      | Details                       |
|--------------------|------------|-------------------------------|
| HP                 | 8 / 8      | (6 + CON mod)                 |
| AC                 | 11         | (10 + DEX mod)                |
| Initiative         | +1         | (DEX mod)                     |
| Speed              | 30 ft      |                               |
| Hit Dice           | 1d6        | (Sorcerer)                    |
| Proficiency Bonus  | +2         |                               |
| Passive Perception | 11         | (10 + Perception bonus)       |

**Class Features (Sorcerer Level 1):**
*   **Spellcasting:** You use Charisma for your sorcerer spells. You know 4 cantrips and 2 1st-level spells. You have 2 1st-level spell slots per long rest. (Spell Save DC 13, Spell Attack Bonus +5).
*   **Sorcerous Origin:** Wild Magic
    *   **Wild Magic Surge:** When you cast a sorcerer spell of 1st level or higher, the DM can have you roll a d20. On a 1, roll on the Wild Magic Surge table to create a random magical effect.
    *   **Tides of Chaos:** You can gain advantage on one attack roll, ability check, or saving throw. Afterward, the DM can have you roll on the Wild Magic Surge table immediately after you cast a sorcerer spell of 1st level or higher (recharges Tides of Chaos).

**Background Feature (Acolyte):**
*   **Shelter of the Faithful:** You and your companions can receive free healing and care at a temple, shrine, or other established presence of your faith (or non-hostile faiths). You have access to the resources of your temple, though you might need to provide material components for spells.

**Feat:**
*   None

**Spellcasting:**
*   **Spellcasting Ability:** Charisma
*   **Spell Save DC:** 13
*   **Spell Attack Bonus:** +5
*   **Cantrips Known (4):**
    *   *Fire Bolt* (Attack, 1d10 fire damage)
    *   *Mage Hand* (Utility, creates spectral hand)
    *   *Prestidigitation* (Utility, minor magical effects)
    *   *Chill Touch* (Attack, 1d8 necrotic damage, prevents healing, undead disadvantage)
    *   *Thaumaturgy* (Known from Tiefling race)
*   **1st-Level Spells Known (2):**
    *   *Chaos Bolt* (Attack, 1d8 + 1d6 damage, type varies, can leap)
    *   *Mage Armor* (Defense, sets AC to 13 + Dex mod for 8 hours, requires no concentration)
*   **Spell Slots:** 2 (1st Level)

| Weapon           | Atk Bonus | Damage/Type      | Properties                                       |
|------------------|-----------|------------------|--------------------------------------------------|
| Dagger (Melee)   | +3        | 1d4+1 Piercing   | Finesse, Light, Thrown (range 20/60)             |
| Dagger (Thrown)  | +3        | 1d4+1 Piercing   | Finesse, Light, Thrown (range 20/60)             |
| Light Crossbow   | +3        | 1d8+1 Piercing   | Ammunition (range 80/320), Loading, Two-Handed |

**Equipment:**
*   Light Crossbow
*   20 bolts
*   Arcane Focus (Crystal)
*   Explorer's Pack (Includes bedroll, mess kit, 10 torches, 10 days rations, waterskin, 50ft hempen rope)
*   Two Daggers
*   Holy Symbol (Cracked obsidian orb)
*   Prayer book or prayer wheel
*   5 sticks of incense
*   Vestments
*   Set of common clothes
*   Pouch containing 15 gp

| Skill             | Mod | Bonus | Proficient |
|-------------------|-----|-------|------------|
| Acrobatics        | DEX | +1    |            |
| Animal Handling   | WIS | +1    |            |
| **Arcana**        | INT | **+2**| **Yes**    |
| Athletics         | STR | -1    |            |
| Deception         | CHA | +3    |            |
| History           | INT | +0    |            |
| **Insight**       | WIS | **+3**| **Yes**    |
| Intimidation      | CHA | +3    |            |
| Investigation     | INT | +0    |            |
| Medicine          | WIS | +1    |            |
| Nature            | INT | +0    |            |
| Perception        | WIS | +1    |            |
| Performance       | CHA | +3    |            |
| **Persuasion**    | CHA | **+5**| **Yes**    |
| **Religion**      | INT | **+2**| **Yes**    |
| Sleight of Hand   | DEX | +1    |            |
| Stealth           | DEX | +1    |            |
| Survival          | WIS | +1    |            |

**Personality:**
*   **Trait 1:** I idolize a particular hero of my faith and constantly refer to that person's deeds and example.
*   **Trait 2:** Nothing can shake my optimistic attitude.
*   **Ideal:** Aspiration. I seek to prove I can control my power for good and live up to my ideals, matching my actions against high standards.
*   **Bond:** Everything I do is for the common people.
*   **Flaw:** I judge others harshly, and myself even more severely.

***

**Roleplaying Notes for Amona:**

*   **Core Concept:** Amona is a study in contrasts. She's a Tiefling with infernal heritage and unpredictable Wild Magic, yet possesses an unshakeable optimism and a past rooted in religious service (Acolyte). Driven by a desire to help the common folk (Bond) and live up to the example of a hero figure (Trait 1), she aims to master her chaotic power for good (Ideal). However, this aspiration is undercut by a harsh inner critic that judges herself and others severely (Flaw), creating internal tension beneath her positive exterior. Her Chaotic Good alignment suggests she prioritizes doing right over obeying rules, likely finding creative, sometimes unconventional, solutions.

*   **Verbal Style:**
    *   **Vocabulary:** Likely a blend. Her high Charisma (+3) and Persuasion (+5) suggest natural eloquence, while her Acolyte background and Religion/Arcana skills (+2) might lend some formal or theological terms. However, her focus on common people (Bond) and Chaotic nature could mean she easily slips into simpler, direct language. Expect frequent references to her hero figure.
    *   **Tone:** Predominantly upbeat and optimistic (Trait 2). However, her Flaw might surface as sharp judgments (perhaps masked by politeness initially) or moments of intense self-recrimination, especially if her magic goes awry or she feels she's failed someone. Her voice might crackle with energy when discussing ideals or casting spells.
    *   **Conversational Focus:** Often steers towards helping others, discussing ideals, morality, and her hero's example. Her Insight (+3) suggests she pays attention to others' motives, though her optimism might make her initially trusting. The self-judgmental Flaw could lead to her deflecting compliments or focusing on perceived mistakes.
    *   **Sentence Structure:** Likely fluid and engaging (CHA 17), but potentially prone to bursts of enthusiasm or slight tangents, reflecting the Wild Magic within. May occasionally quote (or misquote) texts remembered from her Acolyte days.

*   **Mannerisms (Guidance):**
    *   **Expressiveness:** Use facial expressions and gestures readily (High CHA), projecting warmth and optimism. Smile often.
    *   **Managing Chaos:** Might fidget with her crystal focus or holy symbol, perhaps a subconscious attempt to ground herself or control her magic. When a Wild Magic Surge or Tides of Chaos is used/possible, show visible tension or concentration.
    *   **Contrasting Signals:** Let her Tiefling features (horns, tail?) contrast with her generally open demeanor. Perhaps her tail flicks nervously when she's self-critical, or her eyes glow faintly (Thaumaturgy) when she's passionate.
    *   **Self-Criticism:** When the Flaw manifests, perhaps she avoids eye contact, clenches her fists briefly, or her posture tightens. This provides a visual contrast to her usual optimism.
    *   **Interaction:** Lean into the desire to help. Offer assistance readily. Use Persuasion proactively for good ends, but perhaps show slight surprise or internal conflict if less scrupulous methods (like leveraging her intimidating appearance, even with lower Intimidation score) seem necessary for a good cause.

## Concept ideas

**1. Saving (Local Proof-of-Concept)**

For a Proof-of-Concept (PoC) focused on local saving, simplicity and ease of implementation are key. Here are a few common approaches, with recommendations:

*   **JSON Files (Recommended for PoC):**
    *   **How it works:** Represent your data structures (Characters, Campaign Configs, Ongoing Campaign State, Rulesets) as JSON objects. Save each significant piece of data as a separate `.json` file.
        *   `characters/`: Folder containing `character_name1.json`, `character_name2.json`, etc.
        *   `campaigns/configs/`: Folder for campaign templates/setups: `my_custom_campaign.json`, `lost_mines_of_phandelver.json`.
        *   `campaigns/ongoing/`: Folder for active game states: `session_1_lmofp.json`, `my_epic_adventure_state.json`.
        *   `rulesets/`: Folder for rulesets: `dnd5e_core.json`, `homebrew_rules.json`.
    *   **Pros:**
        *   Human-readable and easy to debug manually.
        *   Natively supported by JavaScript (if using web tech) and Python, easy to parse/stringify.
        *   No database setup required.
        *   Easy for users to potentially share/backup manually.
        *   Good fit for document-like data (a character sheet, a campaign definition).
    *   **Cons:**
        *   Can become inefficient with very large amounts of data or frequent writes (though likely fine for a PoC).
        *   Managing relationships between data (e.g., which characters are in which campaign state) requires careful handling within your application logic.
        *   Saving ongoing campaign state needs discipline: you need to decide *when* to save (e.g., after each player action, end of "scene", manually triggered save) and ensure you capture the *entire* relevant state (chat history, character HP/spell slots/conditions, location, quest flags, etc.).

**Recommendation for PoC:** Start with **JSON files**. It's the simplest way to get started, aligns well with common web development practices, and is sufficient for managing the kind of structured data you've described at a PoC scale. Structure your data clearly within the JSON, and organize your files logically in folders.

**2. Structured AI Output for Chat**

Yes, you absolutely need structured output from the AI GM. Relying on parsing natural language is fragile and limiting. Requesting a structured format (like JSON) is the way to go.

Here's a potential structure for the AI's response object:

```json
{
  "narrative": "The heavy stone door groans open, revealing a dark, damp chamber. The air smells of mildew and decay. In the center, you see a crumbling stone altar. A faint shuffling sound echoes from the shadows in the far corner. What do you do?",
  "dice_requests": [
    // Example: Passive perception might be requested immediately
    // {
    //   "request_id": "dr_passive_perc_entry",
    //   "character_ids": ["all"], // Or specific character IDs like ["thora_id", "borin_id"]
    //   "type": "passive_skill_check",
    //   "skill": "Perception",
    //   "reason": "Checking for immediate details upon entering the room."
    // },
    // Example: If combat starts, initiative might be requested
    // {
    //   "request_id": "dr_initiative",
    //   "character_ids": ["all", "monster_goblin_1", "monster_goblin_2"], // Include GM-controlled entities
    //   "type": "initiative",
    //   "reason": "Combat has started!"
    // }
    // Example: Requesting a specific check based on potential future action
     {
       "request_id": "dr_listen_check",
       "character_ids": ["player_character_id"], // ID of character attempting to listen
       "type": "skill_check",
       "skill": "Perception",
       "dice_formula": "1d20+{perception_modifier}", // Your app substitutes the modifier
       "reason": "Attempting to identify the shuffling sound.",
       "dc": 13 // Optional: The AI might know the DC
     }
  ],
  "location_update": {
    "name": "Damp Altar Chamber",
    "description": "A medium-sized chamber carved from rough stone. Features a central crumbling altar and shadowy corners. Smells of mildew.",
    "tags": ["dungeon", "altar", "shadows", "damp"] // Keywords for potential map gen later
  },
  "game_state_updates": [
      // Optional: Explicit state changes the AI wants to enforce
      // { "type": "condition_add", "character_id": "thora_id", "condition": "Frightened" },
      // { "type": "hp_change", "character_id": "borin_id", "amount": -5, "source": "Trap" }
  ],
  "gm_private_notes": "The shuffling sound is two Goblins hiding behind the altar, waiting to ambush. DC 13 Perception to spot them before they attack." // For GM reference, not shown to player directly, but useful for context.
}
```

**Key Considerations for Structured Output:**

*   **Prompt Engineering:** You'll need to carefully craft your prompts to the AI, instructing it to *always* respond in this JSON format. Include examples in the prompt.
*   **Function Calling / Tools:** If the AI model supports it (like many newer OpenAI models, Gemini, Claude 3 via their APIs, potentially available through OpenRouter), this is often more reliable. You define functions (e.g., `requestDiceRoll`, `presentChoices`, `updateLocation`) and their parameters, and the AI calls these functions with the data, which your application then executes.
*   **Handling Dice Rolls:**
    *   The AI requests a roll (`dice_requests`).
    *   Your application identifies the character(s), looks up their relevant stats (modifier for the skill/save/attack), potentially adds advantage/disadvantage based on game state.
    *   Your local dice roller (could be simple JS `Math.random`) performs the roll.
    *   The result is sent *back* to the AI in the next prompt, along with the player's chosen action (either from the choices or free text).
    *   The AI then generates the next response based on the action and the roll result.
*   **Flexibility:** The structure should be flexible enough to handle various situations (combat, exploration, social interaction). Combat rounds might involve multiple `dice_requests` (attack, damage, saving throws) within a single logical turn sequence.

**3. AI Integration (OpenRouter & Kokoro)**

*   **OpenRouter:**
    *   Acts as a gateway. You'll interact with its API endpoint.
    *   Choose models based on capability (instruction following, context window size, function calling support), cost, and speed.
    *   Your application backend (or potentially frontend, carefully managing API keys) will send the formatted prompt (current game state, character sheets, chat history, player action, structured output request) to OpenRouter and parse the structured JSON response.
*   **Kokoro (Local TTS):**
    *   You'll need to run Kokoro locally.
    *   Your application (likely the backend if you have one, or potentially frontend if Kokoro exposes a local web service or JS bindings) will need to:
        1.  Take the `narrative` text from the AI's JSON response.
        2.  Send this text to the Kokoro process/API.
        3.  Receive the audio output (e.g., as a file path or audio stream).
        4.  Play the audio through the web UI.
    *   This keeps the TTS local and potentially free, which is great for an open-source project.

## Observations after concept ideas

### AI Integration

In the end, we can start the PoC by using llamacpp. I have windows 11, and llamacpp installed. I am not sure what the best way would be to use llamacpp but I essentially want the program to easily allow the user to "plug" its favorite AI to use. But we need a common way to allow both closed source (through OpenRouter e.g.) and local open-source AIs to run.
Some AIs also have thinking so we will need to ignore such things (still display it in an expensible box in the chat?)

### Function Calling

Let's use that in our code. We can start with all those basic functions mentioned in the concept ideas. I can imagine that the AI will thus be able to roll dices through its dice_requests. But we need a separate user_dice_request maybe, so that the user can decide himself to either roll a real dice and input the result or click a button to roll a simulated dice.

